name: Alert if maintainer edit permission has not been granted

on:
  pull_request_target:
    types: [opened, reopened]

jobs:
  check-edit-permission:

    runs-on: ubuntu-latest

    if: |
      github.event.pull_request.head.repo.fork == true
      && github.event.pull_request.maintainer_can_modify == false

    steps:
      - name: Update base branch and alert with information
        uses: actions/github-script@v3.1.0
        with:
          github-token: '${{ secrets.GITHUB_TOKEN }}'
          script: |
            const new_branch = `pr-${context.issue.number}`

            try {
              // Create a new branch off the original base/target branch
              // Fails if branch already exists
              await github.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${new_branch}`,
                sha: context.payload.pull_request.base.sha
              })

              // Merge the head of the PR into the new branch
              await github.repos.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: new_branch,
                head: context.payload.pull_request.head.sha,
                commit_message: `Merge pull request ${context.issue.number}`
              })
            } catch (e) {
              github.log.debug(e)
            }

            const message = `@${context.payload.pull_request.user.login} Thank you for your submission!

            In order to speed up the review process we request pull request authors to grant us edit permission for the branch.

            You can do this by checking the box on the right sidebar labeled as either "Allow edits from maintainers" or "Allow edits and access to secrets by maintainers".

            More information can be found on this page: [Allowing changes to a pull request from a fork](https://docs.github.com/en/free-pro-team@latest/github/collaborating-with-issues-and-pull-requests/allowing-changes-to-a-pull-request-branch-created-from-a-fork)`

            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

